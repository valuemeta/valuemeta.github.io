<!DOCTYPE html>

<html lang="en">

<head>

  <title>PoE Incremental</title>

  <link rel="stylesheet" href="stylesheet.css">

  <link rel="shortcut icon" href="images/favicon.ico">

  <script src="scripts/chance.js"></script>
  <script src="scripts/papaparse.min.js"></script>

</head>

<body onload="initialize();">

  <script>

    // Global test variable
    var test = [];

    // Array for saving the loot since loot is converted between visual
    // and array based formats depending on tab
    var loot = [];
    var loot_queue = [];

    // Initializes the start page type
    var current_page = "start";
    // Character index for pages
    var current_character_index = -1;

    // General Currency Data
    var general_currency = ["Orb of Transmutation", "Orb of Augmentation"];
    var general_currency_counts = [0, 0];

    // Divination card data
    var divination_cards = [];
    var stacked_deck_probabilities = [];
    var divination_card_tiers = [];

    // Div Card Counts
    var divination_card_counts = [];

    // Character Array
    var characters = [];

    // Navigation Bar
    var navigation_bar = `
    <nav class="NavigationBar">
    <a class="NavigationButton noselect" href="javascript:void(0)" onclick="transition('loot');">Loot</div>
    <a class="NavigationButton noselect" href="javascript:void(0)" onclick="transition('general_currency');">General Currency</a>
    <a class="NavigationButton noselect" href="javascript:void(0)" onclick="transition('divination_cards');">Divination Cards</a>
    <a class="NavigationButton noselect" href="javascript:void(0)" onclick="transition('character_creation');">Create a new character</a>
    </nav>
    <div id="main_content" class="main_content">
    </div>
    `;

    // Places a divination card down while the loot tab is open according to its name
    function placeDivinationCard(name) {

      // Initialize the outer UI element
      var card = document.createElement("div");
      card.className = "item_outer_container";
      card.setAttribute("onclick", "pickUpItem(this);")
      card.setAttribute("onmouseover", "lootHoverOver(this);")
      card.setAttribute("onmouseout", "lootHoverOut();")

      var selected_card_tier = divination_card_tiers[divination_cards.indexOf(name)];

      // Find the selected card's icon in the loot filter
      switch (selected_card_tier) {
        case 1:
          var selected_card_icon = " red_star";
          break;
        case 2:
          var selected_card_icon = " red_triangle";
          break;
        case 3:
          var selected_card_icon = " yellow_triangle";
          break;
        case 4:
          var selected_card_icon = " white_triangle";
          break;
        default:
          var selected_card_icon = "";
      }

      // Make the UI elements look like a drop
      card.innerHTML = `
      <div class="T` + selected_card_tier + `_divination_card_inner_container ` + "bright " + "noselect" + `">
      <label class="T` + selected_card_tier + `_divination_card_text">
      <div class="` + selected_card_icon + `_image"></div> ` + name +
        `</label>
      </div>`;

      // Drop the card
      document.getElementById("LootContainer").appendChild(card);

    }

    // Opens a stacked deck when the loot tab is open
    function open_stacked_deck() {

      // Select the result of the stacked deck
      var selected_card = chance.weighted(divination_cards, stacked_deck_probabilities);

      // Places the card down as a UI element
      dropItem(selected_card);

      // Play the sound if applicable
      switch (divination_card_tiers[divination_cards.indexOf(selected_card)]) {
        case 1:
          var audio = new Audio("sounds/AlertSound6.mp3");
          audio.play();
          break;
        case 2:
          var audio = new Audio("sounds/AlertSound1.mp3");
          audio.play();
          break;
        case 3: // Fallthrough
        case 4:
          var audio = new Audio("sounds/AlertSound2.mp3");
          audio.play();
          break;
        default:
      }
    }

    // Event of picking up an item on the loot page
    function pickUpItem(item) {

      // Remove the item
      loot.splice(Array.prototype.indexOf.call(item.parentNode.children, item), 1);
      item.remove();

      // Remove the displayer
      lootHoverOut(item);

      // Get and clean the card name
      var item_name = item.childNodes[1].textContent.trim();

      // Increment the count
      divination_card_counts[divination_cards.indexOf(item_name)]++;

    }

    // Transitions between tabs
    function transition(future_page, future_character_index = -1) {

      // Check if its redundant to switch tabs
      if (current_page == future_page) {
        if (current_character_index == future_character_index) {
          return;
        }
      }

      // Cleans up currently loaded page and saves any necessary data
      switch (current_page) {

        case "loot":

          break;

        case "general_currency":
          break;

        case "divination_cards":
          break;

        case "character_creation":
          break;

        case "equipment":
          break;

        case "map_queue":
          break;

        case "start":
          console.log("Application started!")
          // At the start set the navigation bar once
          document.body.innerHTML = navigation_bar;
          break;

        default:
        // TODO: Error checking for non valid integer indices and bad strings

      }

      // Loads in the wanted page
      switch (future_page) {

        case "loot":

          document.getElementById("main_content").style.display = "block";

          // Add stacked deck button and the loot simulator
          document.getElementById("main_content").innerHTML = `
          <button type="button" class="stacked_deck" onclick="open_stacked_deck();"></button>
          <div class="LootSimulator" id="LootContainer"></div>
          <div class="LootDisplayer" id="LootDisplayer"></div>
          `;

          // Put all the saved loot onto the screen
          for (j = 0; j < loot.length; j++) {
            placeDivinationCard(loot[j]);
          }

          break;

        case "general_currency":

          document.getElementById("main_content").style.display = "block";

          // Add the currency count elements to the page
          var html = "";
          for (i = 0; i < general_currency.length; i++) {
            html = html + `<a class="T5_divination_card_text" id="` + general_currency[i] + ` Count"></a><br>`
          }
          document.getElementById("main_content").innerHTML = html;

          // Set the card counts to the variables and add formatting
          for (i = 0; i < general_currency.length; i++) {
            document.getElementById(general_currency[i] + " Count").innerHTML = general_currency_counts[i] + " " + `<div class="generic_icon"
            style="background:url('images/` + general_currency[i].replace(/ /g, "\\ ").replace(/'/g, "\\'") + `\ inventory_icon.png');
            background-size:cover;"></div>` + " " + general_currency[i];
          }

          break;

        case "divination_cards":

          document.getElementById("main_content").style.display = "block";

          // Add the divination card count elements to the page
          var html = "";
          for (i = 0; i < divination_cards.length; i++) {
            html = html + `<a class="T5_divination_card_text" id="` + divination_cards[i] + ` Count"></a><br>`
          }
          document.getElementById("main_content").innerHTML = html;

          // Set the card counts to the variables and add formatting
          for (i = 0; i < divination_cards.length; i++) {
            document.getElementById(divination_cards[i] + " Count").innerHTML = divination_card_counts[i] + " " + `<div class="divination_card_icon"></div>` + " " + divination_cards[i];
          }

          break;

        case "character_creation":

          document.getElementById("main_content").style.display = "block";

          // Add a selection drop down menu to select character class
          document.getElementById("main_content").innerHTML = `
          <label>
          Character Name: 
          </label>
          <input type="text" id="CharacterName">
          <label>
          Character Class: 
          </label>
          <select id="CharacterClass">
          <option>Marauder</option>
          <option>Ranger</option>
          <option>Witch</option>
          <option>Duelist</option>
          <option>Templar</option>
          <option>Shadow</option>
          <option>Scion</option>
          </select>
          <br>
          `;

          // Add a button to create a character using the selected character class
          document.getElementById("main_content").innerHTML += `
          <button onclick="CreateCharacter();">
          Create Character
          </button>
          `;

          break;

        case "equipment":

          document.getElementById("main_content").style.display = "flex";

          document.getElementById("main_content").innerHTML = `
          <div class="tool_tip">
          Tooltip: tooltip
          </div>
          <div class="character_equipment">
          </div>
          <div class="equipment_selection">
          PlaceholderforequipmentselectionPlaceholderforequipmentselection
          </div>
          `;

          break;

        case "map_queue":

          document.getElementById("main_content").style.display = "flex";

          document.getElementById("main_content").innerHTML = `
          <div class="generic_flex">
            Currency Placeholder
          </div>
          <div class="generic_flex">
            Map placeholder
          </div>
          <div class="generic_flex">
            Scarabs and fragments and divine vessel, key, placeholder
          </div>
          <div class="map_queue_last_column">
            <div class="generic_horizontal_flex">
            Map Queue
            </div>
            <div class="map_queue_bottom">
              <div class="map_device_1">
                <div class="generic_flex">
                  Zana Mod
                </div>
                <div class="generic_flex">
                  Atlas Missions
                </div>
              </div>
              <div class="map_device_2">
                <div>
                  Image of map device slots
                </div>
                <div>
                  Queue Button
                </div>
                <div>
                  <div>
                  Toggle Thingy
                  </div>
                  <div>
                  Selector
                  </div>
                </div>
              </div>
              <div class="map_device_3">
                Sextant modifier selection
              </div>
            </div>
          </div>
          `;

          break;

        default:
        // TODO: Error checking for non valid integer indices and bad strings



      }

      // Set the current page to the future page as we are done modifying the page
      current_page = future_page;

      current_character_index = future_character_index;

    }

    // Initializes the game
    function initialize() {

      // Load csv into arrays in memory
      Papa.parse("https://valuemeta.github.io/data/DivinationCardData.csv", {
        download: true,
        complete: function (results) {
          var divination_card_data = results.data;

          // Place them into the arrays
          // Convert the things that should be numbers into numbers
          for (i = 1; i < divination_card_data.length; i++) {
            divination_cards[i - 1] = divination_card_data[i][0];
            stacked_deck_probabilities[i - 1] = Number.parseFloat(divination_card_data[i][1]);
            divination_card_tiers[i - 1] = Number.parseFloat(divination_card_data[i][2]);
          }

          // Set the card counts to 0 depending on the number of cards
          divination_card_counts.length = divination_cards.length;
          divination_card_counts.fill(0);
        }
      });

      // Load the loot page
      // TODO: BEWARE OF LETTING PLAYERS PLAY BEFORE THE GAME IS DONE LOADING
      transition("loot");

    }

    // Show the actual divination card when hovered over in loot tab
    // TODO: Fix Text Size
    // TODO: Test All the divination card images
    // TODO: Check that all divination cards are displayed as intended once everything is done
    function lootHoverOver(element) {

      // Get and clean the card name
      var item_name = element.childNodes[1].textContent.trim();

      // Set the card elements
      document.getElementById("LootDisplayer").innerHTML = `
      <div class="divination_card_art" id="divination_card_art"></div>
      <div class="divination_card_frame"></div>
      <div class="divination_card_name noselect">` + item_name + `</div>
      `;

      // Set the card art
      document.getElementById("divination_card_art").style.background = "url('images/" + item_name.replace(/ /g, "\\ ").replace(/'/g, "\\'") + "\ card_art.png')";

      document.getElementById("LootDisplayer").style.display = "block";
    }

    // Remove the divination card when hovered over in loot tab
    function lootHoverOut() {
      document.getElementById("LootDisplayer").style.display = "none";
    }

    // Create a new character event
    function CreateCharacter() {

      // Empty Object that will represent the character data
      var character = {};

      // Get the name of the character and set it
      // TODO: Make sure names are unique
      character.name = document.getElementById("CharacterName").value;

      // Get the class of the character and set the object's class
      var select = document.getElementById("CharacterClass");
      character.class = select.options[select.selectedIndex].text;

      // Set some basic attributes that depend on class
      switch (character.class) {
        case "Marauder":
          character.base_intelligence = 14;
          character.base_dexterity = 14;
          character.base_strength = 32;
          character.unarmed_damage = { physical: [2, 8] };
          break;
        case "Ranger":
          character.base_intelligence = 14;
          character.base_dexterity = 32;
          character.base_strength = 14;
          character.unarmed_damage = { physical: [2, 5] };
          break;
        case "Witch":
          character.base_intelligence = 32;
          character.base_dexterity = 14;
          character.base_strength = 14;
          character.unarmed_damagee = { physical: [2, 5] };
          break;
        case "Duelist":
          character.base_intelligence = 14;
          character.base_dexterity = 23;
          character.base_strength = 23;
          character.unarmed_damage = { physical: [2, 6] };
          break;
        case "Templar":
          character.base_intelligence = 23;
          character.base_dexterity = 14;
          character.base_strength = 23;
          character.unarmed_damage = { physical: [2, 6] };
          break;
        case "Shadow":
          character.base_intelligence = 23;
          character.base_dexterity = 23;
          character.base_strength = 14;
          character.unarmed_damage = { physical: [2, 5] };
          break;
        case "Scion":
          character.base_intelligence = 20;
          character.base_dexterity = 20;
          character.base_strength = 20;
          character.unarmed_damage = { physical: [2, 6] };
          break;
        default:
          console.log("Invalid Character Class (Can't set base attributes)");
      }

      // Set some basic attributes that don't depend on class
      character.level = 1;
      character.base_life = 50;
      character.life = character.base_life;
      character.base_mana = 40;
      character.mana = character.base_mana;
      character.unarmed_attack_speed = 1.2;
      character.base_accuracy = 0;
      character.base_evasion = 56;
      character.base_fire_resistance = 0;
      character.base_cold_resistance = 0;
      character.base_lightning_resistance = 0;
      character.base_chaos_resistance = 0;

      // TODO: difficulty (minus res) or just depend on level
      // Set some basic methods that we need
      character.current_strength = function () {
        return this.base_strength;
      }

      character.current_dexterity = function () {
        return this.base_dexterity;
      }

      character.current_intelligence = function () {
        return this.base_intelligence;
      }

      character.current_life = function () {
        return this.base_life + (this.level - 1) * 12 + Math.round(this.current_strength() / 2);
      }

      character.current_life_regen = function () {
        return 0;
      }

      character.current_mana = function () {
        return this.base_mana + (this.level - 1) * 6 + Math.round(this.current_intelligence() / 2);
      }

      character.current_mana_regen = function () {
        return 0.018 * this.current_mana();
      }

      character.current_accuracy = function () {
        return this.base_accuracy + (this.level - 1) * 2 + this.current_dexterity() * 2;
      }

      character.current_evasion = function () {
        return Math.round((this.base_evasion + (this.level - 1) * 3) * (1 + this.current_dexterity() / 500));
      }

      character.current_fire_resistance = function () {
        return 0;
      }

      character.current_cold_resistance = function () {
        return 0;
      }

      character.current_lightning_resistance = function () {
        return 0;
      }

      character.current_chaos_resistance = function () {
        return 0;
      }

      // Finally, add the character to the character list
      characters.push(character);

      // Update the navigation bar's elements
      navigation_bar = `
      <nav class="NavigationBar">
      <a class="NavigationButton noselect" href="javascript:void(0)" onclick="transition('loot');">Loot</div>
      <a class="NavigationButton noselect" href="javascript:void(0)" onclick="transition('general_currency');">General Currency</a>
      <a class="NavigationButton noselect" href="javascript:void(0)" onclick="transition('divination_cards');">Divination Cards</a>
      `

      // Add additional elements according to the characters
      for (i = 0; i < characters.length; i++) {
        navigation_bar += `
        <a class="NavigationButton noselect" onclick="toggleDropdown(this)">` + characters[i].name + "▼" + `</a>
        <div class="DropdownContainer">
        <a class="NavigationButton noselect" href="javascript:void(0)" onclick="transition('equipment',` + i.toString() + `);">Equipment</a>
        <a class="NavigationButton noselect" href="javascript:void(0)" onclick="transition('skill_tree',` + i.toString() + `);">Skill Tree</a>
        <a class="NavigationButton noselect" href="javascript:void(0)" onclick="transition('map_queue',` + i.toString() + `);">Map Queue</a>
        <a class="NavigationButton noselect" href="javascript:void(0)" onclick="transition('mapping',` + i.toString() + `);">Mapping</a>
        </div>
        `;
      }

      // Complete the navigation bar
      navigation_bar += `
      <a class="NavigationButton noselect" href="javascript:void(0)" onclick="transition('character_creation');">Create a new character</a>
      </nav>
      <div id="main_content" class="main_content">
      </div>
      `;

      // Apply changes to nav bar
      document.body.innerHTML = navigation_bar;

      // Transition to the character page
      transition("equipment", characters.length - 1);
    }

    // Toggles the dropdown menu of an element
    function toggleDropdown(element) {

      var container = element.nextElementSibling;

      if (container.style.display == "none") {
        container.style.display = "block";
      } else {
        container.style.display = "none";
      }
    }

    // Drops an item
    function dropItem(item) {

      // Add the item to the loot array
      loot.push(item);

      if (current_page == "loot") {
        placeDivinationCard(item);
      }

    }

  </script>

</body>



</html>